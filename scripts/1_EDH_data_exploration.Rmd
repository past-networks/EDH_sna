---
title: "EDH people: extraction of the dataset and basic exploration"
author: 
- Petra Hermankova^[Aarhus University, Denmark, https://orcid.org/0000-0002-6349-0540]
date: "`r format(Sys.Date())`"
output:
  html_document:
    theme: united
    toc: yes
    toc_float: true
    number_sections: true
    toc_depth: 3
    df_print: paged
---

_Purpose of this script is to create a smaller subsection of the full [Epigraphic Database Heidelberg (**EDH**) dataset](https://zenodo.org/record/4888168/) that can be further explored for the purpose of the SNA within the **Past Social Network Project**, Aarhus University. A basic exploration of useful attributes connected to people on inscriptions, such as gender, age, social status, is included._


**WARNING!** The following code was designed for the 2021 version. As some attributes in the 2022 version changed, you may have to alter the code below where necessary.


# Initial setup

```{r setup, echo=TRUE, message=FALSE, warning = FALSE}

knitr::opts_chunk$set(message = FALSE, warning = FALSE)

library(tidyverse)
library(jsonlite)
library(stringi)
```

```{r dowloading data}
# getwd() # check you working directory
dir.create("../data")
dir.create("../data/large_data")

# download as a local copy from Zenodo
# version 2021 (81476)
# download.file("https://zenodo.org/record/4888168/files/EDH_text_cleaned_2021-01-21.json?download=1", "../data/large_data/EDH_text_cleaned_2021-01-21.json")

########### WARNING! In case you get an error message, you may have to manually download the dataset from Zenodo and save it to the 'large_data' folder. Don't forget to check if the dataset or the entire folder is in your .gitignore file, otherwise you are risking accidental commit to GitHub and than having to deal with removing the large file from your commit. 

# version 2022 (81883)
# download.file("https://zenodo.org/record/7303886/files/EDH_text_cleaned_2022-11-03.json?download=1", "../data/large_data/EDH_text_cleaned_2022-11-03.json")


########### WARNING! The following code was designed for the 2021 version. As some attributes in the 2022 version changed, you may have to alter the code below where necessary.
```

```{r loading data}
# 2021
list_json <- jsonlite::fromJSON("../data/large_data/EDH_text_cleaned_2021-01-21.json")

# 2022
#list_json <- jsonlite::fromJSON("../data/large_data/EDH_text_cleaned_2022-11-03.json")

EDH <- as_tibble(list_json)
```


# Subset the dataset to the minimal useful version

```{r dataset filtering}
EDHs<- EDH %>% 
  select(id,
         coordinates, findspot_ancient_clean, province_label_clean, modern_region_clean,
         not_before, not_after,
        type_of_monument_clean, material_clean,
    type_of_inscription_clean,
    transcription, clean_text_interpretive_word, 
    people
    ) %>% 
  separate(col = coordinates, into = c("latitude", "longitude"), sep = ",")

EDHs$longitude <- as.numeric(str_replace(EDHs$longitude, pattern = "\\)", replacement=""))
EDHs$latitude <- as.numeric(str_replace(EDHs$latitude, pattern = "c\\(", replacement=""))
```


```{r extracting people}
EDHs$people <- map(EDHs$people, as.data.frame)
EDH_people<- EDHs %>% unnest_longer(col = people, keep_empty = TRUE)
EDH_people<- EDH_people %>% 
  unnest_wider(people)
```

```{r display few records}
head(EDH_people, 10)
```


# Data exploration & streamlining

## People on inscriptions

### How many people there are per inscription (average, min, max)
```{r how many people}
summary(as.numeric(EDH_people$person_id))
```

## Gender

### What is the gender ratio of people on inscriptions? (male, female, NA)
```{r gender}
EDH_people %>% 
  count(gender, sort = TRUE) %>% 
  mutate(ratio = round(n/(sum(n)/100),2))
```

## Status

### What are the names of unique values in the 'status' attribute?
```{r status}
EDH_people$status %>% 
  unique()
```


### What is the ratio of different statuses, e.g. slave vs freedman

```{r processing status}
str_split_fixed(EDH_people$status, ";", n=3) %>% 
  as.data.frame() -> status

status %>% 
  cbind(combined = c(status$V1,status$V2,status$V3)) %>% 
  filter(combined != "") %>% 
  mutate(combined_clean = str_replace_all(string = combined, pattern = "\\?", replacement = "")) %>% 
  mutate(combined_clean = str_replace_all(string = combined_clean, pattern = "^ ", replacement = "")) %>% 
  count(combined_clean, sort=TRUE) -> status_counts

status_counts 
```

```{r status figures}
status_counts %>% 
  mutate(combined_clean = reorder(combined_clean, n)) %>% 
  ggplot(aes(y=combined_clean, x=n, fill=combined_clean)) +
  geom_col(width=0.8, stat="identity") +
  coord_cartesian(xlim=c(0,10000)) +
  labs(x = "Number of instances", y = "Status category", title = "Overview of status references in the EDH dataset", subtitle = ggtitle(paste("n =", nrow(EDHs), "inscriptions"))) +
  geom_label(aes(label= n)) +
  theme_linedraw(base_size = 13) +
  theme(legend.position = "none")


dir.create("../figures")
ggsave("../figures/Status_overview.jpg", width = 12, height = 8) 
ggsave("../figures/Status_overview.png", width = 12, height = 8) 
```

## Age

Before we can display the age of people, we need to streamline the age as it is recorded as character and distributed over several attributes, such as age in years, months, days. Then convert them to numeric value and save as total age in years.

```{r processing age}
EDH_people<- EDH_people %>% 
  mutate(age_years = as.numeric(str_extract(EDH_people$'age: years', pattern = "[:digit:]+"))) %>% 
  mutate(age_months = as.numeric(str_extract(EDH_people$'age: months', pattern = "[:digit:]+"))) %>%
  mutate(age_days = as.numeric(str_extract(EDH_people$'age: days', pattern = "[:digit:]+"))) %>%
  mutate(age_hours = as.numeric(str_extract(EDH_people$'age: hours', pattern = "[:digit:]+"))) %>% 
  mutate(months_to_years = age_months / 12) %>% 
  mutate(days_to_years = age_days / 365) %>% 
  mutate(hours_to_years = age_hours / (24*365)) %>% 
  replace_na(list(months_to_years = 0, days_to_years = 0, hours_to_years = 0)) %>% 
  mutate(total_age = age_years + months_to_years + days_to_years + hours_to_years) %>% 
  dplyr::select(-ends_with("to_years")) %>% 
  dplyr::select(-starts_with("age: "))

```

### Summary of age in years

```{r total age summary}
summary(EDH_people$total_age)
```

### How many percent of people state their age on inscriptions
```{r age on inscriptions}
length(na.omit(EDH_people$total_age))/(nrow(EDH_people)/100)
```


## Origin

Before we can display the origin of people, we need to streamline the text and clean it from uncertainty symbols and other variations. That way, we can get as close to the original place name as possible.

```{r cleaning origo}
EDH_people <- EDH_people %>%
  mutate(origo_clean = str_replace_all(origo, pattern="[\\*|\\+|\\?|\\!]", replacement="")) %>%
  mutate(origo_clean = str_replace_all(origo_clean, pattern="(\\w+) \\(= (\\w+)\\)", replacement="\\2")) %>%
  mutate(origo_clean = str_replace_all(origo_clean, pattern="gente|genitus|gentis|natus|civis|Civis|civus|natione|nato|regione|domo|domu|cives|cive|civi|ex|verna|tate", replacement="")) %>%
  mutate(origo_clean = str_replace_all(origo_clean, pattern="^ ", replacement="")) %>%
  mutate(origo_clean = str_replace_all(origo_clean, pattern="  ", replacement=" ")) 
```

### Summary of origo
```{r origo overview}
table(EDH_people$origo_clean) %>% 
  sort(decreasing = TRUE) %>% 
  as.data.frame()
```

## Names and family ties

### Family name (nomen)

Description as found at the EDH website:

```
Nomen / Nomina of a person named in the inscription. 

Here one can search for the occurrence of a nomen independent of case, spelling and state of preservation on the inscription bearer.

Spelling:
- Always in the nominative irrespective of the case in the inscription.
- correct spelling without brackets
- In the case of the emperors up to and including Nero Caesar is treated as a part of the name.


Resolution of abbreviations and supplements / erasures are not indicate by round or square brackets ( ), [ ], [[ ]], [[[ ]]], but through:
* = resolved
+ = supplemented
++ = erased, but still readable
+++ = erased and no longer readable

```

```{r nomen exploration}
EDH_people %>% 
  count(nomen, sort=T)
```

Cleaning of the family name for our purposes:

```{r cleaning nomen}
#####WARNING! This code needs to be commented out when knitting.

EDH_people<- EDH_people %>% 
  mutate(nomen_clean = str_replace_all(EDH_people$nomen, "\\+{1,3}", "")) %>% 
  mutate(nomen_clean = str_replace_all(EDH_people$nomen_clean, "\\*", "")) %>% 
  mutate(nomen_clean = str_replace_all(EDH_people$nomen_clean, "[\\+\\*]", "")) %>% 
  mutate(nomen_clean = str_replace_all(EDH_people$nomen_clean, "[\\!]", "")) %>% 
  mutate(nomen_clean = str_replace_all(EDH_people$nomen_clean, "\\)\\?", "\\)")) %>% 
  mutate(nomen_clean = str_replace_all(EDH_people$nomen_clean, "\\?", "")) 
```

```{r encoding conversion}
library(stringi)

# Convert the encoding of the nomen_clean column
# EDH_people$nomen_clean <- iconv(EDH_people$nomen_clean, from = "UTF-8", to = "windows-1252")

```


```{r clean nomen overview}
EDH_people %>% 
  count(nomen_clean, sort=T)
```

```{r, index number for people}

# creating a unique ID number for people
EDH_people$id_people <- 1:nrow(EDH_people)

# renaming variable describing the number of people on one inscription
EDH_people <-rename(EDH_people, person_number_insc = person_id)

```



Ordering the attributes so they are ordered logically
```{r ordering}
EDH_people<- EDH_people %>% 
  select(id, latitude, longitude, findspot_ancient_clean, province_label_clean, modern_region_clean, not_before, not_after, type_of_monument_clean, material_clean, type_of_inscription_clean, transcription, clean_text_interpretive_word, id_people, person_number_insc, name, praenomen, nomen, nomen_clean, cognomen, supernomen, gender, origo, status, total_age, age_years, age_months, age_months, age_hours)
```




# Save the streamlined data as CSV
```{r save CSV}
dir.create("../data")
write.csv(EDH_people, "../data/EDH_people_2021.csv", row.names=TRUE, sep = ";")

```

